# Claude Experiment Prompt — v1.5.0 Hybrid Chunking (Stability + Mutation Tolerance)

You are Claude Code, acting as a senior ML systems engineer and research engineer.

This prompt defines v1.5.0, a hybrid chunking experiment motivated directly by the negative result in v1.4.0. It tests whether representational coherence and mutation tolerance can be composed rather than traded off.

This prompt must comply with CLAUDE.md, AGENTS.md, AGENT archival, jj/git discipline, and minor version auto-tagging.

---

## Canonical Start Prompt (Authoritative)

Context: Continue the curv-embedding project.
- v1.2.0 showed stability-driven chunking improves structural coherence and reduces ingest-time maintenance.
- v1.3.0 showed streaming chunking approximates offline segmentation within the commit horizon.
- v1.4.0 showed a negative result: fixed-size overlapping chunking exhibits higher mutation tolerance than stability-driven chunking under localized edits.

Goal: Test a hybrid chunking policy that preserves stability-driven chunking for static regions while applying local, overlapping micro-chunking only within edit windows, and evaluate whether this reduces re-embed cost and churn without sacrificing global coherence.

Hypothesis: A hybrid policy that combines stability-driven base chunks with localized overlapping chunks in edit regions will:
- reduce re-embed fraction relative to pure stability-driven chunking,
- preserve chunk coherence away from edits,
- and approach or exceed baseline mutation tolerance while retaining fewer total chunks overall.

Constraints: deterministic, reproducible, no changes to embedding model, ANN backend, or diagnostic computation.

Deliverables: hybrid chunker implementation, temporal experiment runs, drift/churn/maintenance metrics, paper-ready artifacts, manifests.

Non-goals: learning adaptive chunkers, replacing ANN, optimizing semantic accuracy, changing diagnostics.

---

## Required Takeaway to Log from v1.4.0 (Mandatory)

Before implementing v1.5.0, record the following interpretive takeaway verbatim in:
- AGENT/<T>-out.md for v1.4.0 (if not already), and
- the v1.5.0 experiment summary.

**Takeaway (v1.4.0):** Stability-driven chunking optimizes representational coherence but increases sensitivity to localized edits due to larger chunk granularity, while fixed-size overlapping chunking provides higher mutation tolerance by limiting invalidation scope. Representational stability and mutation tolerance are distinct, competing objectives.

This takeaway must be referenced in the v1.5.0 CHANGELOG.md entry.

---

## Hybrid Chunking Policy (Authoritative)

### Base segmentation
- Perform stability-driven chunking on the full document at t0 (offline or streaming).
- These chunks form the base segmentation and are treated as stable until edits occur.

### Edit detection
- Use existing update simulation to detect edit windows:
  - byte offset range [e_start, e_end]
- Expand the window by a guard band:
  - [e_start - G, e_end + G], where G is configurable (e.g., 128–256 bytes).

### Local re-chunking (micro-chunks)

Within the guarded edit window only:
- discard the affected base chunk(s),
- re-chunk the window using fixed-size overlapping chunks:
  - size = micro_chunk_bytes (e.g., 512–1024)
  - overlap = micro_overlap_bytes (e.g., 64–128)

Outside the edit window:
- keep base stability-driven chunks unchanged.

### Identity & manifests
- Base chunks retain their original chunk_content_id when unchanged.
- Micro-chunks receive new chunk_instance_id but are linked via:
  - parent_chunk_id
  - edit_window_id

All relationships must be logged in the manifest.

---

## Required TOML knobs

Add under [chunking.hybrid]:

```toml
enabled = true
micro_chunk_bytes = 768
micro_overlap_bytes = 96
guard_band_bytes = 256
```

---

## Required Metrics (Authoritative)

Compare three policies:
1. Fixed-size overlapping (baseline)
2. Stability-driven only
3. Hybrid (v1.5.0)

Measure:

### A) Mutation tolerance
- reembed_fraction
- chunks_unchanged

### B) Embedding drift & neighbor churn
- same metrics as v1.4.0

### C) Structural overhead
- total chunk count
- mean/p90 chunk size
- fraction of micro-chunks vs base chunks

### D) Localization efficiency
- fraction of re-embeds confined to edit windows

---

## Runs (Name exactly like this)

Use today's date as YYYYMMDD.
- v1.4.0-baseline-temporal-YYYYMMDD
- v1.4.0-stability-temporal-YYYYMMDD
- v1.4.0-hybrid-temporal-YYYYMMDD

---

## Execution Plan (Parallelize)

- Subagent A: hybrid chunker implementation + manifests
- Subagent B: baseline temporal run
- Subagent C: stability temporal run
- Subagent D: hybrid temporal run
- Subagent E: metrics aggregation + plots + paper artifacts

---

## Steps (Do in Order)

### 0) AGENT archive (mandatory)
- Compute UNIX time <T>.
- Save this prompt to AGENT/<T>-in.md.

### 1) Checkout latest tag and set up env

```bash
git checkout v1.4.0
uv venv .venv
source .venv/bin/activate
```

### 2) Run temporal experiments

```bash
uv run scripts/run_experiment.py --run-name v1.4.0-baseline-temporal-YYYYMMDD
uv run scripts/run_experiment.py --run-name v1.4.0-stability-temporal-YYYYMMDD
uv run scripts/run_experiment.py --run-name v1.4.0-hybrid-temporal-YYYYMMDD
```

### 3) Aggregate metrics

Produce:
- paper/tables/temporal_hybrid_v1.4.0.tex
- paper/figures/temporal_hybrid_v1.4.0.pdf

---

## Post-cycle release: v1.5.0 (mandatory)

After completion:
- Update VERSION → 1.5.0
- Add CHANGELOG.md entry:

```markdown
## v1.5.0
- Introduce hybrid chunking (stability base + local overlapping micro-chunks)
- Validate composition of representational coherence and mutation tolerance
- Explicitly incorporate v1.4.0 negative-result takeaway
- AGENT prompt used: `AGENT/<T>-in.md`
```

- Commit via jj, push, tag annotated v1.5.0, push tags.

---

## Stop Condition

Stop when:
- hybrid chunker implemented
- three-policy temporal comparison complete
- metrics and paper artifacts generated
- AGENT archive committed/pushed
- v1.5.0 tagged and pushed
