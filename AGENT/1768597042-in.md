# Claude Experiment Prompt — v2.0.0 Representational Reranking (Post–Cost-Corrected Baseline)

You are Claude Code, acting as a senior ML systems engineer and research engineer.

This prompt initiates v2.0.0, which introduces representational reranking on top of the now-corrected chunking and cost model. All prior ambiguity has been resolved by v1.6.0, which established the correct mutation-cost metric and validated hybrid chunking under realistic system costs.

This is the first cycle that changes retrieval behavior, not chunking or embedding generation.

Must comply with CLAUDE.md, AGENTS.md, AGENT archival, jj/git discipline, and major version tagging (v2.0.0).

---

## Canonical Start Prompt (Authoritative)

Context: Continue the curv-embedding project.

Established facts:
- v1.2–v1.3: Stability-driven chunking is structurally coherent and streaming-feasible.
- v1.4: Stability-only chunking is mutation-sensitive under naive metrics.
- v1.5: Hybrid chunking localizes change but appeared worse under count-based cost.
- v1.6: Cost-weighted (byte-based) metrics reversed the ranking; hybrid chunking is best under realistic mutation cost.

These results fix the representation and update layers. This cycle evaluates retrieval semantics.

Goal: Evaluate whether representational reranking—using stored stability and strain diagnostics—improves retrieval consistency and robustness over ANN-only cosine similarity, given a cost-corrected hybrid chunking baseline.

Hypothesis: Given stable, localized chunking and correct cost metrics, representational reranking will:
- increase top-k overlap under updates and query reformulation,
- reduce boundary-induced retrieval instability,
- without materially increasing mutation cost or breaking determinism.

Constraints: deterministic, reproducible; no changes to chunking, embedding, or FAISS index construction.

Deliverables: reranking implementation, comparison runs, stability metrics, paper-ready artifacts, manifests.

Non-goals: replacing ANN entirely, training new models, optimizing benchmark accuracy.

---

## Required Notes to Carry Forward from v1.6.0 (Mandatory)

Before running v2.0.0 experiments, log the following context note verbatim in:
- AGENT/<T>-in.md for this cycle, and
- the CHANGELOG.md entry for v2.0.0.

**Context (v1.6.0):** Count-based mutation metrics mischaracterized hybrid chunking by treating all chunks as equal cost. Byte-weighted metrics showed that hybrid chunking reduces effective mutation cost by 54% relative to baseline, resolving the apparent negative result and establishing hybrid chunking as the correct base policy for dynamic vector stores.

---

## Reranking Method (Authoritative v2.0.0)

### Candidate generation

- Use FAISS cosine similarity to retrieve a candidate set of size K0 (e.g., 200).
- This step is unchanged from v1.x and remains metric-based.

### Representational reranking score

For each candidate chunk c, compute:

```
score(c) =
  + alpha * sim_cos(c)
  - beta  * strain(c)
  - gamma * boundary_penalty(c)
  - delta * instability_risk(c)
```

Where:
- `sim_cos(c)` is the original cosine similarity score
- `strain(c)` derives from stored diagnostics (curvature percentile, stability margin)
- `boundary_penalty(c)` reflects proximity to unstable or edit-prone boundaries
- `instability_risk(c)` uses historical drift/byte-weighted mutation cost (if available)

All inputs must come from stored SQLite metadata; no new encoding is allowed.

Defaults (configurable):
- alpha = 1.0
- beta  = 0.6
- gamma = 0.4
- delta = 0.2

---

## Required TOML knobs

Add to config:

```toml
[rerank]
enabled = true
mode = "ann_repr"
K0 = 200
k = 10
alpha = 1.0
beta = 0.6
gamma = 0.4
delta = 0.2
seed = 1337
```

---

## Evaluation Metrics (Authoritative)

Evaluate three retrieval modes:
1. **ann** — cosine only
2. **ann_random** — random rerank control
3. **ann_repr** — representational rerank

Measure:

### A) Retrieval stability
- `topk_overlap@k` across:
  - temporal updates (t0 → t1 → t2)
  - query reformulations

### B) Boundary robustness
- overlap within ±N bytes of known chunk boundaries
- reduction in boundary-induced churn vs ANN-only

### C) Mutation interaction check
- confirm byte-weighted mutation cost remains unchanged relative to v1.6.0

### D) Rerank disagreement rate
- fraction of queries where ann_repr differs from ann

---

## Runs (Name exactly like this)

Use today's date as YYYYMMDD.
- v1.6.0-ann-YYYYMMDD
- v1.6.0-ann_random-YYYYMMDD
- v1.6.0-ann_repr-YYYYMMDD

---

## Execution Plan (Parallelize)

- Subagent A: reranker module + SQLite diagnostic fetch
- Subagent B: ANN baseline + random control runs
- Subagent C: representational rerank runs
- Subagent D: metrics aggregation + plots
- Subagent E: tests (determinism, mode parity)

---

## Steps (Do in Order)

### 0) AGENT archive (mandatory)

- Compute UNIX time <T>.
- Save this prompt to AGENT/<T>-in.md.

### 1) Checkout baseline

```bash
git checkout v1.6.0
uv venv .venv
source .venv/bin/activate
```

### 2) Run retrieval experiments

```bash
uv run scripts/query_eval.py --mode ann --run-name v1.6.0-ann-YYYYMMDD
uv run scripts/query_eval.py --mode ann_random --run-name v1.6.0-ann_random-YYYYMMDD
uv run scripts/query_eval.py --mode ann_repr --run-name v1.6.0-ann_repr-YYYYMMDD
```

---

### 3) Aggregate metrics and artifacts

Generate:
- paper/tables/rerank_stability_v2.0.0.tex
- paper/figures/rerank_overlap_v2.0.0.pdf
- paper/figures/rerank_boundary_v2.0.0.pdf

---

### 4) Record execution output

Write summary to AGENT/<T>-out.md including:
- stability deltas
- boundary robustness deltas
- confirmation mutation cost unchanged

Commit and push AGENT files.

---

## Post-cycle release: v2.0.0 (mandatory)

After completion:
- Update VERSION → 2.0.0
- Add CHANGELOG.md entry:

```markdown
## v2.0.0
- Introduce representational reranking over ANN candidates
- Evaluate retrieval stability using cost-corrected hybrid chunking baseline
- Carry forward v1.6.0 cost-metric correction
- AGENT prompt used: `AGENT/<T>-in.md`
```

- Commit via jj, push, tag annotated v2.0.0, push tags.

---

## Stop Condition

Stop when:
- reranking implemented and tested
- three-mode comparison complete
- paper artifacts generated
- AGENT archive committed/pushed
- v2.0.0 tagged and pushed

Do not modify chunking or embedding behavior in this cycle.
