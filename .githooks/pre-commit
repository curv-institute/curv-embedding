#!/bin/bash
# Pre-commit hook: rebuild paper/main.pdf if any paper assets changed

set -e

# Check if any paper files are staged
PAPER_CHANGED=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '^paper/.*\.(tex|bib|pdf)$' || true)

if [ -n "$PAPER_CHANGED" ]; then
    echo "Paper files changed, rebuilding paper/main.pdf..."

    # Save current directory
    REPO_ROOT=$(git rev-parse --show-toplevel)
    cd "$REPO_ROOT/paper"

    # Build PDF (suppress most output, show errors)
    pdflatex -interaction=nonstopmode -halt-on-error main.tex > /dev/null 2>&1 || {
        echo "ERROR: pdflatex failed on first pass"
        exit 1
    }

    # Run bibtex if .bib changed or citations are undefined
    if git diff --cached --name-only | grep -q '\.bib$' || grep -q 'undefined references' main.log 2>/dev/null; then
        bibtex main > /dev/null 2>&1 || true
        pdflatex -interaction=nonstopmode -halt-on-error main.tex > /dev/null 2>&1 || true
    fi

    # Final pass for references
    pdflatex -interaction=nonstopmode -halt-on-error main.tex > /dev/null 2>&1 || {
        echo "ERROR: pdflatex failed on final pass"
        exit 1
    }

    cd "$REPO_ROOT"

    # Add the rebuilt PDF to the commit
    if [ -f paper/main.pdf ]; then
        git add paper/main.pdf
        echo "paper/main.pdf rebuilt and staged"
    fi

    # Clean up auxiliary files
    rm -f paper/*.aux paper/*.log paper/*.bbl paper/*.blg paper/*.out 2>/dev/null || true
fi

exit 0
